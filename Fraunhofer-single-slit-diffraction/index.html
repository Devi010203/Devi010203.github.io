<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>光学衍射模拟器</title>
  <style>
    .container {
      display: flex;
      align-items: center;
      /* 新增：垂直居中 */
      padding: 20px;
      background: #1a1a1a;
      color: white;
      height: 100vh;
      /* 新增：占满视口 */
      box-sizing: border-box;
      /* 新增：防止padding影响高度 */
    }

    .controls {
      width: 220px;
      padding: 20px;
      background: #2d2d2d;
      border-radius: 12px;
      margin-right: 30px;
    }

    .slider-container {
      margin: 20px 0;
    }

    canvas {
      width: 800px;
      /* 新增：与属性尺寸一致 */
      height: 600px;
      /* 新增：与属性尺寸一致 */
      background: black;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    input[type="range"] {
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="controls">
      <div class="slider-container">
        <label>波长λ: <span id="lambdaValue">525</span> nm</label>
        <input type="range" id="lambda" min="380" max="750" value="525">
      </div>
      <div class="slider-container">
        <label>缝宽b: <span id="bValue">0.50</span> mm</label>
        <input type="range" id="b" min="100" max="500" value="500">
      </div>
      <div class="slider-container">
        <label>焦距f: <span id="fValue">5</span> cm</label>
        <input type="range" id="f" min="5" max="50" value="5">
      </div>
    </div>
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>

  <script>
    //======= 物理常量与单位转换 =======//
    const SCALE_FACTOR = 1e6; // μm → meters换算比例

    //======= DOM元素获取 =======//
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const lambdaSlider = document.getElementById('lambda');
    const bSlider = document.getElementById('b');
    const fSlider = document.getElementById('f');
    const lambdaValue = document.getElementById('lambdaValue');
    const bValue = document.getElementById('bValue');
    const fValue = document.getElementById('fValue');

    //======= 核心绘制函数 =======//
    function drawDiffractionPattern() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 物理参数转换
      const lambda = parseInt(lambdaSlider.value) * 1e-9;  // nm → m
      const b = parseInt(bSlider.value) * 1e-6;            // mm → m 
      const f = parseInt(fSlider.value) * 1e-2;            // cm → m

      // 创建单行像素数据
      const yCenter = canvas.height / 2;
      const rowData = new Uint8ClampedArray(canvas.width * 4);

      for (let x = 0; x < canvas.width; x++) {
        // 计算物理坐标偏移量（对称坐标系）
        const u = (x - canvas.width / 2) * 1e-6;  // 从中心出发
        const alpha = (Math.PI * b * u) / (lambda * f);

        // 计算相对光强并抑制高次项
        let relativeIntensity = Math.pow(alpha !== 0 ? Math.sin(alpha) / alpha : 1, 2);
        relativeIntensity = Math.pow(relativeIntensity, 0.4); // 增强可见性

        // 转换波长→色相
        // 修改后的色相计算
        const hue = 270 - 270 * (lambda * 1e9 - 380) / (750 - 380); // 380-750nm → 270°→0° // 反向映射
        const brightness = Math.min(95, relativeIntensity * 50); // 亮度映射

        // 生成颜色
        const rgb = HSLtoRGB(hue, 100, brightness);
        const baseIndex = x * 4;
        rowData[baseIndex] = rgb.r;
        rowData[baseIndex + 1] = rgb.g;
        rowData[baseIndex + 2] = rgb.b;
        rowData[baseIndex + 3] = 255;
      }

      // 创建临时离屏Canvas
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = 1;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.putImageData(new ImageData(rowData, canvas.width, 1), 0, 0);

      // 渲染到主画布（禁用插值保证线条锐利）
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(
        tempCanvas,
        0, 0, canvas.width, 1,    // 源区域
        0, 0, canvas.width, canvas.height // 目标区域（垂直拉伸）
      );
    }

    //======= 实用函数 =======//
    function HSLtoRGB(h, s, l) {
      h /= 360;
      s /= 100;
      l /= 100;

      let r, g, b;
      if (s === 0) {
        r = g = b = l;
      } else {
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1 / 6) return p + (q - p) * 6 * t;
          if (t < 1 / 2) return q;
          if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
          return p;
        };

        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1 / 3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1 / 3);
      }

      return {
        r: Math.round(r * 255),
        g: Math.round(g * 255),
        b: Math.round(b * 255)
      };
    }

    //======= 事件处理 =======//
    function refreshValues() {
      lambdaValue.textContent = lambdaSlider.value;
      bValue.textContent = (parseInt(bSlider.value) / 1000).toFixed(2); // μm → mm显示
      fValue.textContent = fSlider.value;

      requestAnimationFrame(drawDiffractionPattern); // 性能优化
    }

    // 初始化事件监听
    [lambdaSlider, bSlider, fSlider].forEach(slider => {
      slider.addEventListener('input', refreshValues);
    });

    // 初始渲染
    refreshValues();

  </script>
</body>

</html>